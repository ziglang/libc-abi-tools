# musl ABI tools

This directory contains `.abilist` files from every version of musl starting
from 1.2.0. These files are consolidated to generate a single 37 KB symbol
mapping file that is shipped with Zig to target any version of musl starting
from that point.

Unlike [glibc](../glibc), these `.abilist` files are generated by inspecting
the actual `libc.so` ELF file. We do it this way because musl does not have
`.abilist` files for its libc, and in fact does not use symbol versioning at
all.

## Generating `.abilist` files for a new musl version

1. Follow [these instructions](https://github.com/ziglang/zig/wiki/Updating-libc#musl).

2. Make sure that `arches` is up to date.

3. Run the tool to generate the new `.abilist` files:

   ```sh
   zig run collect.zig -- $MUSL_SYSROOT_PATH $MUSL_VERSION
   ```

   Where:

   * `MUSL_SYSROOT_PATH` contains `aarch64`, `i386`, etc directories.
   * `MUSL_VERSION` should be e.g. `1.2.5`.

   Pay attention to any warnings printed; make adjustments as necessary, e.g. to
   `blacklist`.

4. This inspects the ELF shared libraries for each target you built earlier and
   generates `.abilist` files namespaced under the version number.

5. Inspect the changes and then commit these new files into Git.

## Updating Zig

1. Add the new musl versions to the `versions` global constant.

2. Make sure that `zig_targets` is up to date.

3. Run `consolidate.zig` in this directory.

   ```sh
   zig run consolidate.zig
   ```

This will generate the file `abilists` which you can then inspect and make sure
it is OK. Copy it to `$ZIG_GIT_REPO_PATH/lib/libc/musl/abilists`.

## Format Quirks

Compared to [glibc](../glibc), the `.abilist` files here have some differences:

* The first field containing the version name is missing because musl does not
  use symbol versioning.
* There can be an extra field containing a `W` before the category field. If
  present, this indicates that the symbol has weak linkage.
